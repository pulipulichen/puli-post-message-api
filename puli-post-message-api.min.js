function PuliPostMessageAPI(){let k;window.opener?k=window.opener:window.parent&&window.parent!==window&&(k=window.parent);let q=function(a){"complete"===document.readyState||"interactive"===document.readyState?setTimeout(a,1):document.addEventListener("DOMContentLoaded",a)};k&&q(function(){k.postMessage({eventName:"ready",url:location.href},"*")});let n={},l={},d={},m={},r=function(a){!1===Array.isArray(d[a])&&(d[a]=[]);return new Promise(function(c,b){d[a].push(function(){c(!0)});console.log(d[a].length,
a);if(1===d[a].length)d[a][0]()})},t=function(a){d[a].shift();console.log("_ExecuteNextSendWait",a);0<d[a].length&&setTimeout(function(){d[a][0]()},0)},w=async function(a,c,b){await u(c);a().postMessage({eventName:"send",data:b,url:location.href},c);return new Promise(function(a,b){v(c,function(b){a(b)})})},e={},v=function(a,c){e[a]||(e[a]=[]);-1===e[a].indexOf(c)&&e[a].push(c)},x=function(a,c){if(!1===Array.isArray(e[a]))return!1;e[a].forEach(function(a){if("function"!==typeof a)return!1;a(c)});
e[a]=[];t(a);return!0},y=async function(a,c,b){let f;"function"===typeof p&&(f=await p(b));a.postMessage({eventName:"return",data:f,url:location.href},c)},u=function(a){return!0===n[a]?!0:new Promise(function(c,b){l[a]=function(){c(!0)}})};window.addEventListener("message",function(a){if("object"!==typeof a.data||!a.data.eventName)return!1;let c=a.data.eventName,b=a.data.data,f=a.data.url;a=a.source;"return"===c?x(f,b):"send"===c?y(a,f,b):"ready"===c&&(n[f]=!0,"function"===typeof l[f]&&(l[f](),delete l[f]))},
!0);let p;return{send:async function(a,c,b,f){a=(new URL(a,document.baseURI)).href;await r(a);"function"!==typeof b||f||(f=b,b=void 0);let d="iframe";b&&b.mode&&(d=b.mode);let e,g;if(m[a])e=m[a];else if("iframe"===d)g=document.createElement("iframe"),g.style.display="none",g.src=a,document.body.appendChild(g);else if("popup"===d){var h=void 0;b&&b.target&&(h=b.target);let c=void 0;b&&b.features&&(c=b.features);e=window.open(a,h,c)}h=!0;b&&(!1===b.autoClose?h=b.autoClose:"popup"===b.mode&&(h=!1));
c=await w(function(){e||"iframe"!==d||(e=g.contentWindow);return e},a,c);!1===h&&(m[a]||(m[a]=e));!0===h&&("iframe"===d?g.parentNode.removeChild(g):e.close(),delete n[a]);"function"===typeof f&&f(c);return c},onReceive:function(a){if("function"!==typeof a)return!1;p=a}}};
function PuliPostMessageAPI(f){f=f?f:{};f="boolean"===typeof f.maunalReady?f.maunalReady:!1;let n;window.opener?n=window.opener:window.parent&&window.parent!==window&&(n=window.parent);let v=function(a){"complete"===document.readyState||"interactive"===document.readyState?setTimeout(a,1):document.addEventListener("DOMContentLoaded",a)};n&&!1===f&&v(function(){r()});let r=function(){if(!0===t)return!1;t=!0;n.postMessage({eventName:"ready",url:location.href},"*")},t=!1,q={},p={},g={},l={},w=function(a){!1===
Array.isArray(g[a])&&(g[a]=[]);return new Promise(function(b,c){g[a].push(function(){b(!0)});if(1===g[a].length)g[a][0]()})},u=function(a){g[a].shift();0<g[a].length&&setTimeout(function(){g[a][0]()},0)},z=async function(a,b,c,d){await x(b);a().postMessage({eventName:"send",eventType:c,data:d,url:location.href},b);return new Promise(function(a,c){y(b,function(c){a(c)})})},e={},y=function(a,b){e[a]||(e[a]=[]);-1===e[a].indexOf(b)&&e[a].push(b)},A=function(a,b){if(!1===Array.isArray(e[a]))return!1;
e[a].forEach(function(a){if("function"!==typeof a)return!1;a(b)});e[a]=[];u(a);return!0},B=async function(a,b,c,d){if("function"===typeof m[c])c=await m[c](d);else return a.postMessage({eventName:"error",message:"sender's eventType is not found: "+c,url:location.href},b),!1;a.postMessage({eventName:"return",data:c,url:location.href},b)},x=function(a){return!0===q[a]?!0:new Promise(function(b,c){p[a]=function(){b(!0)}})};window.addEventListener("message",function(a){if("object"!==typeof a.data||!a.data.eventName)return!1;
let b=a.data.eventName,c=a.data.data,d=a.data.url,g=a.data.eventType,f=a.source;"return"===b?A(d,c):"send"===b?B(f,d,g,c):"ready"===b?(q[d]=!0,"function"===typeof p[d]&&(p[d](),delete p[d])):"error"===b&&(console.error(a.data.message),e[d]=[],u(d))},!0);let m={};return{send:async function(a,b,c){a=(new URL(a,document.baseURI)).href;await w(a);c=c?c:{};let {eventType:d,callback:g}=c;d=d?d:"default";let f="iframe";c&&c.mode&&(f=c.mode);let e,h;if(l[a])e=l[a];else if("iframe"===f)h=document.createElement("iframe"),
h.style.display="none",h.src=a,document.body.appendChild(h);else if("popup"===f){var k=void 0;c&&c.target&&(k=c.target);let b=void 0;c&&c.features&&(b=c.features);e=window.open(a,k,b)}k=!1;c&&(!0===c.autoClose?k=c.autoClose:"undefined"===typeof c.autoClose&&"popup"===c.mode&&(k=!1));b=await z(function(){e||"iframe"!==f||(e=h.contentWindow);return e},a,d,b);!0===k?("iframe"===f?h&&h.parentNode.removeChild(h):e.close(),delete q[a],delete l[a]):l[a]||(l[a]=e);"function"===typeof g&&g(b);return b},addReceiveListener:function(a,
b){"function"!==typeof a||b||(b=a,a="default");if("function"!==typeof b)return!1;m[a]=b},removeReceiveListener:function(a,b){"function"!==typeof a||b||(b=a,a="default");if("function"!==typeof b||!m[a])return!1;delete m[a]},ready:function(){r()}}};
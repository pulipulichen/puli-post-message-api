window.PuliPostMessageAPIInited=!1;let cacheAPI=null;function PuliPostMessageAPI(e){if(!0===window.PuliPostMessageAPIInited)return cacheAPI;window.PuliPostMessageAPIInited=!0;let t,n=location.href.slice(location.href.lastIndexOf("/")+1),o="boolean"==typeof(e=e||{}).manuallyReady&&e.manuallyReady;window.opener?t=window.opener:window.parent&&window.parent!==window&&(t=window.parent);var i;t&&!1===o&&(i=function(){r()},"complete"===document.readyState||"interactive"===document.readyState?setTimeout(i,1):document.addEventListener("DOMContentLoaded",i));let r=function(){if(!0===a)return!1;a=!0,t&&t.postMessage({eventName:"ready",url:location.href},"*")},a=!1,u={},d={},s={},l={},c=function(e){s[e].shift(),s[e].length>0&&setTimeout(function(){s[e][0]()},0)},f={},w=async function(e,t,n){e=function(e){return"string"==typeof f[e]?f[e]:e}(e=new URL(e,document.baseURI).href),await function(e){return!1===Array.isArray(s[e])&&(s[e]=[]),new Promise(function(t,n){s[e].push(function(){t(!0)}),1===s[e].length&&s[e][0]()})}(e),n=n||{};let{eventType:o,callback:i,newWindow:r}=n;o=o||"_default";let a="iframe";n&&n.mode&&(a=n.mode);let d=!1;n&&n.debug&&(d=!0);let c,m,y=!1;if(n&&(!0===n.autoClose?y=n.autoClose:void 0===n.autoClose&&"popup"===n.mode&&(y=!1)),"popup"===a&&!0===r&&l[e])delete u[e],delete l[e];else if(!0===y&&l[e]){if("iframe"===a){let t=document.querySelector(`iframe[data-url="${e}"]`);null!==t&&t.parentNode.removeChild(t)}else"popup"===a&&l[e].close();delete u[e],delete l[e]}if(l[e])c=l[e];else if("iframe"===a)null===(m=document.querySelector(`iframe[data-url="${e}"]`))&&((m=document.createElement("iframe")).style.position="fixed",m.style.width="100px",m.style.height="100px",m.style.zIndex=-1,m.style.opacity=0,m.style.right=0,m.style.bottom=0,!0===d&&(m.style.zIndex=999,m.style.opacity=1,m.style.width="500px",m.style.height="500px"),m.src=e,m.setAttribute("data-url",e),document.body.appendChild(m));else if("popup"===a){let t=void 0;n&&n.target&&(t=n.target);let o=void 0;n&&n.features&&(o=n.features),c="number"==typeof o&&o<=1?function(e,t,n){t="number"==typeof t?t:.8,n="string"==typeof n?n:"_blank";var o=screen.availWidth*t,i=screen.availHeight*t;o=o<300?300:o,i=i<300?300:i;var r=navigator.userAgent,a=function(){return/\b(iPhone|iP[ao]d)/.test(r)||/\b(iP[ao]d)/.test(r)||/Android/i.test(r)||/Mobile/i.test(r)},u=void 0!==window.screenX?window.screenX:window.screenLeft,d=void 0!==window.screenY?window.screenY:window.screenTop,s=void 0!==window.outerWidth?window.outerWidth:document.documentElement.clientWidth,l=void 0!==window.outerHeight?window.outerHeight:document.documentElement.clientHeight-22,c=a()?null:o,f=a()?null:i,w=u<0?window.screen.width+u:u,p=parseInt(w+(s-c)/2,10),m=parseInt(d+(l-f)/2.5,10),y=[];null!==c&&y.push("width="+c),null!==f&&y.push("height="+f),y.push("left="+p),y.push("top="+m);var h=window.open("",n,y.join(","));return h.document.write(`<script>window.moveTo(${p}, ${m});window.resizeTo(${c}, ${f})<\/script>`),h.document.write(`<script>location.href="${e}"<\/script>`),window.focus&&h.focus(),h}(e,o):window.open(e,t,o)}let h,v,g=function(){return c||"iframe"!==a||(c=m.contentWindow),c};try{h=await p(g,e,o,t)}catch(e){v=e,y=!0}return!0===y?("iframe"===a?m&&m.parentNode.removeChild(m):c.close(),delete u[e],delete l[e]):l[e]||(l[e]=c),v?(await(P=1e3,P=P||100,new Promise(function(e){setTimeout(function(){e(!0)},P)})),await w(v,t,n)):("function"==typeof i&&i(h),h);var P},p=async function(e,t,n,o,i){let r=await I(t);if("string"==typeof r)throw r;let a=e(),u={eventName:"send",eventType:n,data:o,url:location.href};return new Promise(function(e,n){a.postMessage(u,t),y(t,function(t){e(t)})})},m={},y=function(e,t){m[e]||(m[e]=[]),-1===m[e].indexOf(t)&&m[e].push(t)},h=function(e,t){return!1!==Array.isArray(m[e])&&(m[e].forEach(function(e){if("function"!=typeof e)return!1;e(t)}),m[e]=[],c(e),!0)},v=async function(e,t,n,o){let i;if("function"!=typeof b[n])return e.postMessage({eventName:"error",message:"sender's eventType is not found: "+n,url:location.href},t),!1;i=await b[n](o),e.postMessage({eventName:"return",data:i,url:location.href},t)},g=function(e){if("function"==typeof d[e])u[e]=!0,d[e](),delete d[e];else for(let t in d){let n=d[t];return f[t]=e,delete d[t],n(e),!1}},P=function(e,t){return console.error(t,n),m[e]=[],c(e),!0},I=function(e){return!0===u[e]||new Promise(function(t,n){d[e]=function(e){t(e||!0)}})};window.addEventListener("message",function(e){if("object"!=typeof e.data||!e.data.eventName)return!1;let t=e.data.eventName,n=e.data.data,o=e.data.url,i=e.data.eventType,r=e.source;"return"===t?h(o,n):"send"===t?v(r,o,i,n):"ready"===t?g(o):"error"===t&&P(o,e.data.message)},!0);let b={};return cacheAPI={send:w,addReceiveListener:function(e,t){if("function"!=typeof e||t){if("function"!=typeof t)return!1}else t=e,e="_default";b[e]=t},removeReceiveListener:function(e,t){if("function"!=typeof e||t||(t=e,e="_default"),"function"!=typeof t||!b[e])return!1;delete b[e]},ready:function(){r()}}}
